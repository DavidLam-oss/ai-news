# 飞书多维表格配置指南

## 1. 创建多维表格

1. 登录飞书开放平台：https://open.feishu.cn/
2. 创建应用并获取 `app_id` 和 `app_secret`
3. 在多维表格中创建新的表格

## 2. 表格字段配置

### 必需字段

| 字段名称 | 字段类型 | 说明 | 示例 |
|---------|---------|------|------|
| 日期 | 日期 | 早报发布日期 | 2024-01-15 |
| 早报原始内容 | 多行文本 | 爬虫获取的原始内容 | JSON格式的原始数据 |
| AI处理后内容 | 多行文本 | 经过AI处理的早报内容 | 简洁的早报摘要 |
| 图片提示词1 | 单行文本 | 第一个图片生成提示词 | AI科技未来场景，简洁现代设计风格 |
| 图片提示词2 | 单行文本 | 第二个图片生成提示词 | 人工智能与人类协作，科技感十足 |
| 图片提示词3 | 单行文本 | 第三个图片生成提示词 | 数字化世界，AI驱动的未来生活 |
| 生成图片 | 附件 | 根据提示词生成的图片 | 图片文件 |
| 状态 | 单选 | 处理状态 | 待处理/处理中/已完成/失败 |
| 创建时间 | 创建时间 | 记录创建时间 | 自动生成 |
| 更新时间 | 最后更新时间 | 记录最后更新时间 | 自动生成 |

### 可选字段

| 字段名称 | 字段类型 | 说明 | 示例 |
|---------|---------|------|------|
| 文章数量 | 数字 | 本次早报包含的文章数量 | 25 |
| 重要新闻 | 多行文本 | 标记为重要的新闻 | 重要新闻列表 |
| 趋势分析 | 多行文本 | AI发展趋势分析 | 趋势分析内容 |
| 备注 | 多行文本 | 其他备注信息 | 备注内容 |

## 3. 自动化工作流配置

### 3.1 创建自动化流程

1. 在多维表格中点击"自动化"按钮
2. 选择"新建自动化流程"
3. 设置流程名称：`AI早报自动生成`

### 3.2 配置触发器

**定时触发**
- 触发条件：每天上午8点
- 时区：Asia/Shanghai
- 重复：每天

### 3.3 配置动作

#### 动作1：调用爬虫API
- 动作类型：发送HTTP请求
- 请求方法：POST
- URL：`http://your-server:8000/api/crawl/run`
- 请求头：
  ```json
  {
    "Content-Type": "application/json"
  }
  ```

#### 动作2：获取早报内容
- 动作类型：发送HTTP请求
- 请求方法：GET
- URL：`http://your-server:8000/api/news`
- 参数：
  ```json
  {
    "max_articles": 50,
    "categories": ["ai", "tech"]
  }
  ```

#### 动作3：处理早报内容
- 动作类型：发送HTTP请求
- 请求方法：POST
- URL：`http://your-server:8000/api/process`
- 请求体：
  ```json
  {
    "articles": "{{动作2的响应数据}}",
    "enhancement_type": "summary"
  }
  ```

#### 动作4：创建表格记录
- 动作类型：新增记录
- 表格：当前表格
- 字段映射：
  - 日期：`{{当前日期}}`
  - 早报原始内容：`{{动作2的响应数据}}`
  - AI处理后内容：`{{动作3的响应数据.summary}}`
  - 图片提示词1：`{{动作3的响应数据.image_prompts[0]}}`
  - 图片提示词2：`{{动作3的响应数据.image_prompts[1]}}`
  - 图片提示词3：`{{动作3的响应数据.image_prompts[2]}}`
  - 状态：`已完成`

#### 动作5：发送到微信（可选）
- 动作类型：发送HTTP请求
- 请求方法：POST
- URL：`http://your-server:8000/api/wechat/send`
- 请求体：
  ```json
  {
    "content": "{{动作3的响应数据.summary}}",
    "target_type": "group"
  }
  ```

## 4. 权限配置

### 4.1 应用权限

在飞书开放平台中为应用添加以下权限：
- `bitable:app:readonly` - 读取多维表格应用
- `bitable:app` - 管理多维表格应用
- `bitable:table:readonly` - 读取表格
- `bitable:table` - 管理表格
- `bitable:record:readonly` - 读取记录
- `bitable:record` - 管理记录

### 4.2 表格权限

确保应用有权限访问目标多维表格：
1. 在多维表格中点击"分享"
2. 添加应用为协作者
3. 设置权限为"可编辑"

## 5. 测试配置

### 5.1 手动测试

1. 在自动化流程中点击"测试运行"
2. 检查每个动作的执行结果
3. 查看表格中是否创建了新记录

### 5.2 日志查看

1. 在飞书开放平台查看应用日志
2. 检查API服务的日志文件
3. 确认数据流转正常

## 6. 故障排除

### 常见问题

1. **API调用失败**
   - 检查服务器是否正常运行
   - 确认API地址和端口正确
   - 查看网络连接是否正常

2. **权限不足**
   - 确认应用权限配置正确
   - 检查表格分享权限
   - 验证访问令牌是否有效

3. **数据格式错误**
   - 检查API响应格式
   - 确认字段映射正确
   - 验证数据类型匹配

4. **定时任务不执行**
   - 检查自动化流程是否启用
   - 确认触发时间设置正确
   - 查看时区配置

### 调试技巧

1. 使用飞书开放平台的调试工具
2. 查看API服务的详细日志
3. 在自动化流程中添加调试动作
4. 使用测试模式验证配置

## 7. 最佳实践

1. **数据备份**：定期备份表格数据
2. **监控告警**：设置失败告警机制
3. **性能优化**：合理设置爬虫频率
4. **安全防护**：保护API密钥和访问令牌
5. **版本管理**：记录配置变更历史
